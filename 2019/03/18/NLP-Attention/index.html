<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Deep Learning,NLP," />










<meta name="description" content="Attention in DP and NLP.">
<meta name="keywords" content="Deep Learning,NLP">
<meta property="og:type" content="article">
<meta property="og:title" content="NLP-Attention">
<meta property="og:url" content="http://yoursite.com/2019/03/18/NLP-Attention/index.html">
<meta property="og:site_name" content="Blog of Qing">
<meta property="og:description" content="Attention in DP and NLP.">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/0_hJfCjjx0r0slacNm.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/0_HNv9BMtUF85ticoe.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/The_transformer_encoder_decoder_stack.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Transformer_encoder.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Transformer_decoder.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/embeddings.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/encoder_with_tensors.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_self_attention_vectors.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_self_attention_score.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/self-attention_softmax.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/self-attention-output.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/self-attention-matrix-calculation.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/self-attention-matrix-calculation-2.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_attention_heads_qkv.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_attention_heads_z.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_attention_heads_weight_matrix_o.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_multi-headed_self-attention-recap.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_positional_encoding_vectors.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_resideual_layer_norm.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_resideual_layer_norm_2.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/transformer_resideual_layer_norm_3.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/1_H29pojIh1fvscvX04gF2Xg.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.06.49%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.11.21%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.12.00%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.19.53%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.23.37%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.23.04%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.37.29%20PM.png">
<meta property="og:image" content="http://yoursite.com/2019/03/18/NLP-Attention/Screen%20Shot%202019-08-02%20at%205.51.16%20PM.png">
<meta property="og:updated_time" content="2019-12-17T23:58:14.677Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NLP-Attention">
<meta name="twitter:description" content="Attention in DP and NLP.">
<meta name="twitter:image" content="http://yoursite.com/2019/03/18/NLP-Attention/0_hJfCjjx0r0slacNm.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/03/18/NLP-Attention/"/>





  <title>NLP-Attention | Blog of Qing</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog of Qing</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/18/NLP-Attention/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qing Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog of Qing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">NLP-Attention</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-18T22:37:35-05:00">
                2019-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NLP/" itemprop="url" rel="index">
                    <span itemprop="name">NLP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Attention in DP and NLP.</p>
<a id="more"></a>
<h1 id="Attention-in-Seq2seq"><a href="#Attention-in-Seq2seq" class="headerlink" title="Attention in Seq2seq"></a>Attention in Seq2seq</h1><p>Remember that our seq2seq model is made of two parts, an encoder that encodes the input sentence, and a decoder that leverages the information extracted by the decoder to produce the translated sentence. Basically, our input is a sequence of words $x_1, …, x_n$ that we want to translate, and our target sentecne is a sequence of words $y_1,…,y_m$.</p>
<ol>
<li><p>Encoder</p>
<p>Let $(h_1,…,h_n)$ be the hidden vectors representing the input sentence. These vectors are the output of a bi-LSTM for instance, and capture contextual representation of each word in the sentence.</p>
</li>
<li><p>Decoder</p>
<p>We want to computer the hidden states $s_i$ of the decoder using a recursive formula of the form</p>
<script type="math/tex; mode=display">
s_i=f(s_{i-1},y_{y-1},c_i)</script><p>where $s_{i-1}$ is the previous hidden vector, $y_{i-1}$ is the generated word at the previous step, and $c_i$ is a context vector that capture the context from the original sentence that is relevant to the time step $i$ of the decoder.</p>
<p>The  contect vector $c_i$ captures relevant information for the $i$-th decoding time step. For each hidden vector from the original sentence $h_j$, compute a score</p>
<script type="math/tex; mode=display">
e_{i,j}=a(s_{i-1},h_j)</script><p>where a is any function with values in $R$, for instance a single layer fully-connceted neural network. Then, we end up with a scalar vaules $e_{i,1},…,e_{i,n}$. Normalize these scores into a vector $\alpha_i=(\alpha_{i,1},…,\alpha_{i,n})$, using a softmax layer.</p>
<script type="math/tex; mode=display">
\alpha_{i, j}=\frac{\exp \left(e_{i, j}\right)}{\sum_{k=1}^{n} \exp \left(e_{i, k}\right)}</script><p>Then, compute the context vector $c_i$ as the weighted average of the hidden vectors from the original sentence</p>
<script type="math/tex; mode=display">
c_{i}=\sum_{j=1}^{n} \alpha_{i, j} h_{j}</script><p>Intuitively, this vector captures the relevant contextual information from the original sentence for the $i$-th step of the decoder.</p>
</li>
</ol>
<h1 id="Attention-in-General"><a href="#Attention-in-General" class="headerlink" title="Attention in General"></a>Attention in General</h1><p>In essence, I will describe Attention Parameters as a projection of a query for a series of key-value pairs as in the below image:</p>
<p><img src="/2019/03/18/NLP-Attention/0_hJfCjjx0r0slacNm.png" alt="_hJfCjjx0r0slacN"></p>
<p>Calculating attention comes primarily in three steps. First, we take the query and each key and compute the similarity between the two to obtain a weight. Frequently used similarity functions include dot product, splice, detector, etc. The second step is typically to use a softmax function to normalize these weights, and finally to weight these weights in conjunction with the corresponding values and obtain the final Attention.</p>
<p>In current NLP work, the key and value are frequently the same, therefore key=value.</p>
<p><img src="/2019/03/18/NLP-Attention/0_HNv9BMtUF85ticoe.png" alt="_HNv9BMtUF85tico"></p>
<h1 id="Self-Attention"><a href="#Self-Attention" class="headerlink" title="Self-Attention"></a>Self-Attention</h1><p>The encoding component is a stack of encoders (the paper stacks six of them on top of each other – there’s nothing magical about the number six, one can definitely experiment with other arrangements). The decoding component is a stack of decoders of the same number.</p>
<p><img src="/2019/03/18/NLP-Attention/The_transformer_encoder_decoder_stack.png" alt="he_transformer_encoder_decoder_stac"></p>
<p>The encoders are all identical in structure (yet they do not share weights). Each one is broken down into two sub-layers:</p>
<p><img src="/2019/03/18/NLP-Attention/Transformer_encoder.png" alt="ransformer_encode">The encoder’s input first flow through a self-attention layer – a layer that helps the encoder look at other words in the input sentence as it encodes a specific word. The outputs of the self-attention layer are fed to a feed-forward neural network. The decoder has both those layers, but between them is an attention layer that helps the decoder focus on relevant parts of the input sentence.</p>
<p><img src="/2019/03/18/NLP-Attention/Transformer_decoder.png" alt="ransformer_decode"></p>
<p>In decoder, the target is fed into the self-attention layer. And the outputs from this layer and encoder are sent to encoder-decoder attention layer.</p>
<h2 id="Bring-the-tensors-into-the-picture"><a href="#Bring-the-tensors-into-the-picture" class="headerlink" title="Bring the tensors into the picture"></a>Bring the tensors into the picture</h2><p>Now that we’ve seen the major components of the model, let’s start to look at the various vectors/tensors and how they flow between these components to turn the input of a trained model into an output.</p>
<p>As is the case in NLP applications in general, we begin by turning each input word into a vector using an embedding layer. </p>
<p><img src="/2019/03/18/NLP-Attention/embeddings.png" alt="mbedding"></p>
<p>After embedding the words in our input sequence, each of them flows through each of the two layers of the encoder.</p>
<p><img src="/2019/03/18/NLP-Attention/encoder_with_tensors.png" alt="ncoder_with_tensor"></p>
<p>The <strong>first step</strong> in calculating self-attention is to create three vectors from each of the encoder’s input vectors (in this case, the embedding of each word). So for each word, we create a Query vector, a Key vector, and a Value vector. These vectors are created by multiplying the embedding by three matrices that we trained during the training process.</p>
<p>Notice that these new vectors are smaller in dimension than the embedding vector. Their dimensionality is 64, while the embedding and encoder input/output vectors have dimensionality of 512. They don’t HAVE to be smaller, this is an architecture choice to make the computation of multiheaded attention (mostly) constant.</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_self_attention_vectors.png" alt="ransformer_self_attention_vector"> </p>
<p>The <strong>second step</strong> in calculating self-attention is to calculate a score. Say we’re calculating the self-attention for the first word in this example, “Thinking”. We need to score each word of the input sentence against this word. The score determines how much focus to place on other parts of the input sentence as we encode a word at a certain position.</p>
<p>The score is calculated by taking the dot product of the query vector with the key vector of the respective word we’re scoring. So if we’re processing the self-attention for the word in position #1, the first score would be the dot product of q1 and k1. The second score would be the dot product of q1 and k2.</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_self_attention_score.png" alt="ransformer_self_attention_scor"></p>
<p>The <strong>third and forth steps</strong> are to divide the scores by 8 (the square root of the dimension of the key vectors used in the paper – 64. This leads to having more stable gradients. There could be other possible values here, but this is the default), then pass the result through a softmax operation. Softmax normalizes the scores so they’re all positive and add up to 1.</p>
<p><img src="/2019/03/18/NLP-Attention/self-attention_softmax.png" alt="elf-attention_softma"></p>
<p>This softmax score determines how much how much each word will be expressed at this position. Clearly the word at this position will have the highest softmax score, but sometimes it’s useful to attend to another word that is relevant to the current word.</p>
<p>The <strong>fifth step</strong> is to multiply each value vector by the softmax score (in preparation to sum them up). The intuition here is to keep intact the values of the word(s) we want to focus on, and drown-out irrelevant words (by multiplying them by tiny numbers like 0.001, for example).</p>
<p>The <strong>sixth step</strong> is to sum up the weighted value vectors. This produces the output of the self-attention layer at this position (for the first word).</p>
<p><img src="/2019/03/18/NLP-Attention/self-attention-output.png" alt="elf-attention-outpu"></p>
<p>That concludes the self-attention calculation. The resulting vector is one we can send along to the feed-forward neural network. In the actual implementation, however, this calculation is done in matrix form for faster processing. So let’s look at that now that we’ve seen the intuition of the calculation on the word level.</p>
<h2 id="Matrix-calculation-of-Self-Attention"><a href="#Matrix-calculation-of-Self-Attention" class="headerlink" title="Matrix calculation of Self-Attention"></a>Matrix calculation of Self-Attention</h2><p><strong>The first step</strong> is to calculate the Query, Key, and Value matrices. We do that by packing our embeddings into a matrix X, and multiplying it by the weight matrices we’ve trained (WQ, WK, WV).</p>
<p><img src="/2019/03/18/NLP-Attention/self-attention-matrix-calculation.png" alt="elf-attention-matrix-calculatio"></p>
<p><strong>Finally</strong>, since we’re dealing with matrices, we can condense steps two through six in one formula to calculate the outputs of the self-attention layer.</p>
<p><img src="/2019/03/18/NLP-Attention/self-attention-matrix-calculation-2.png" alt="elf-attention-matrix-calculation-"></p>
<h2 id="Multi-heads"><a href="#Multi-heads" class="headerlink" title="Multi heads"></a>Multi heads</h2><p>The paper further refined the self-attention layer by adding a mechanism called “multi-headed” attention. This improves the performance of the attention layer in two ways:</p>
<ol>
<li>It expands the model’s ability to focus on different positions. Yes, in the example above, z1 contains a little bit of every other encoding, but it could be dominated by the the actual word itself. It would be useful if we’re translating a sentence like “The animal didn’t cross the street because it was too tired”, we would want to know which word “it” refers to.</li>
<li>It gives the attention layer multiple “representation subspaces”. As we’ll see next, with multi-headed attention we have not only one, but multiple sets of Query/Key/Value weight matrices (the Transformer uses eight attention heads, so we end up with eight sets for each encoder/decoder). Each of these sets is randomly initialized. Then, after training, each set is used to project the input embeddings (or vectors from lower encoders/decoders) into a different representation subspace.</li>
</ol>
<p><img src="/2019/03/18/NLP-Attention/transformer_attention_heads_qkv.png" alt="ransformer_attention_heads_qk"></p>
<p>If we do the same self-attention calculation we outlined above, just eight different times with different weight matrices, we end up with eight different Z matrices</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_attention_heads_z.png" alt="ransformer_attention_heads_"></p>
<p>We concat the matrices then multiple them by an additional weights matrix WO.</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_attention_heads_weight_matrix_o.png" alt="ransformer_attention_heads_weight_matrix_"></p>
<p>That’s pretty much all there is to multi-headed self-attention. It’s quite a handful of matrices, I realize. Let me try to put them all in one visual so we can look at them in one place</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_multi-headed_self-attention-recap.png" alt="ransformer_multi-headed_self-attention-reca"></p>
<h2 id="Sequence-order"><a href="#Sequence-order" class="headerlink" title="Sequence order"></a>Sequence order</h2><p>One thing that’s missing from the model as we have described it so far is a way to account for the order of the words in the input sequence.</p>
<p>To address this, the transformer adds a vector to each input embedding. These vectors follow a specific pattern that the model learns, which helps it determine the position of each word, or the distance between different words in the sequence. The intuition here is that adding these values to the embeddings provides meaningful distances between the embedding vectors once they’re projected into Q/K/V vectors and during dot-product attention.</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_positional_encoding_vectors.png" alt="ransformer_positional_encoding_vector"></p>
<h2 id="The-residuals"><a href="#The-residuals" class="headerlink" title="The residuals"></a>The residuals</h2><p>One detail in the architecture of the encoder that we need to mention before moving on, is that each sub-layer (self-attention, ffnn) in each encoder has a residual connection around it, and is followed by a layer-normalization step.</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_resideual_layer_norm.png" alt="ransformer_resideual_layer_nor"></p>
<p>If we’re to visualize the vectors and the layer-norm operation associated with self attention, it would look like this:</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_resideual_layer_norm_2.png" alt="ransformer_resideual_layer_norm_"></p>
<p>This goes for the sub-layers of the decoder as well. If we’re to think of a Transformer of 2 stacked encoders and decoders, it would look something like this:</p>
<p><img src="/2019/03/18/NLP-Attention/transformer_resideual_layer_norm_3.png" alt="ransformer_resideual_layer_norm_"></p>
<h2 id="Decoder-side"><a href="#Decoder-side" class="headerlink" title="Decoder side"></a>Decoder side</h2><p>The encoder start by processing the input sequence. The output of the top encoder is then transformed into a set of attention vectors K and V. These are to be used by each decoder in its “encoder-decoder attention” layer which helps the decoder focus on appropriate places in the input sequence</p>
<p>The following steps repeat the process until a special symbol is reached indicating the transformer decoder has completed its output. The output of each step is fed to the bottom decoder in the next time step, and the decoders bubble up their decoding results just like the encoders did. And just like we did with the encoder inputs, we embed and add positional encoding to those decoder inputs to indicate the position of each word.</p>
<p>The self attention layers in the decoder operate in a slightly different way than the one in the encoder:</p>
<p>In the decoder, the self-attention layer is only allowed to attend to earlier positions in the output sequence. This is done by masking future positions (setting them to <code>-inf</code>) before the softmax step in the self-attention calculation.</p>
<p>The “Encoder-Decoder Attention” layer works just like multiheaded self-attention, except it <strong>creates its Queries matrix from the layer below it, and takes the Keys and Values matrix from the output of the encoder stack.</strong></p>
<h1 id="Attention-in-GAN"><a href="#Attention-in-GAN" class="headerlink" title="Attention in GAN"></a>Attention in GAN</h1><p><a href="https://medium.com/towards-artificial-intelligence/techniques-in-self-attention-generative-adversarial-networks-22f735b22dfb" target="_blank" rel="noopener">REF1</a> <a href="https://medium.com/@jonathan_hui/gan-self-attention-generative-adversarial-networks-sagan-923fccde790c" target="_blank" rel="noopener">REF2</a> <a href="https://towardsdatascience.com/not-just-another-gan-paper-sagan-96e649f01a6b" target="_blank" rel="noopener">great explanation</a> </p>
<p>Convolutional GANs have difficulty in learning the image distributions of diverse multi-class datasets like Imagenet. It is observed that CGANs could easily generate images with a simpler geometry like Ocean, Sky etc. but failed on images with some specific geometry like dogs, horses and many more. </p>
<p>This problem is arising because the convolution is a local operation whose receptive field depends on the spatial size of the kernel. In a convolution operation, it is not possible for an output on the top-left position to have any relation to the output at bottom-right.</p>
<p>You would ask, Can’t we make the spatial size bigger so that it captures more of the image? Yes! of course we can, but it would decrease computational efficiency achieved by smaller filters and make the operation slow. Then you would again ask, Can’t we make a Deep CGAN with smaller filters so that the later layers have a large receptive field? Yes! we can, but it would take too many layers to have a large enough receptive field and too many layers would mean too many parameters. Hence it would make the GAN training more unstable.</p>
<p>The solutions to keeping computational efficiency and having a large receptive field at the same time is <strong>Self-Attention.</strong> It helps create a balance between efficiency and long-range dependencies(= large receptive fields) by utilizing the famous mechanism from NLP called attention.</p>
<h2 id="The-model"><a href="#The-model" class="headerlink" title="The model"></a>The model</h2><p>The work process is as follows</p>
<p><img src="/2019/03/18/NLP-Attention/1_H29pojIh1fvscvX04gF2Xg.png" alt="_H29pojIh1fvscvX04gF2X"></p>
<p>On the left of the below image, we get our feature maps from the previous convolutional layer. Let’s suppose it is of the dimension $(512\times 7 \times 7)$ where 512 is the number of channels and 7 is the spatial dimension. We first pass the feature map through three $1\times 1$ convolutions separately. We name the three filters $f, g$ and $h$.</p>
<p>What $1\times 1$ convolution does is that it reduces the channel number in the image. The filter size of $f$ and $g$ is 64 while the size of $h$ is 512. After the image gets passed through we get three feature maps of dimensions $(64\times 7\times 7)$, $(64\times 7\times 7)$ and $(512\times 7\times 7)$. These three things are our query, key and value pairs. In order to perform self attention onthe complete image, we flatten out last two dimensions and the dimensions become $(64\times 49)$,  $(64\times 49)$,  $(512\times 49)$. We transpose the query and matrix-multiply it by the key and take the softmax on all the rows. So we get an output attention map of shape $(49\times 49)$. Then we multiple the value vector with the attention map, resulting in output with $(512\times 49)$. One last thing that the paper proposes is that to multiply the final output by a learnable scale parameter and add back the input as a residual connection. Let’s say the $x$ is the image and $o$ is the output, we multiple $o$ by a parameter $y$. The final output $O$ is $O=y<em>o+x$. Initially, the paper advises initializing the sacle parameter as zero so that the output is simple old convolution at the beginning. They initialized $y$ with zero because they wanted their network to rely on the cues in the local neighborhood — since that was easier and then gradually the network will learn to assign the value to </em>y* parameter and use self-attention.</p>
<h1 id="Language-Model"><a href="#Language-Model" class="headerlink" title="Language Model"></a>Language Model</h1><p>Language modeling is the task of predicting what word comes next. More formally, given a sequence of words $x^{(1)}, x^{(2)},…,x^{(t)}, $ compute the probability distribution of the next word $x^{(t+1)}$:</p>
<script type="math/tex; mode=display">
P\left(\boldsymbol{x}^{(t+1)} | \boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(1)}\right)</script><p>where $x^{t+1}$ can be any word in the vocabulary $V={w_1,…,w_{|V|}}$. A system that does this is called a <strong>Language Model</strong>.</p>
<p>We can also think of a Language Model as a system that assigns probability to a piece of text. For example, if we have some text $x^{(1)}, x^{(2)},…,x^{(T)}$, then the probability of this text is:</p>
<script type="math/tex; mode=display">
\begin{aligned} P\left(\boldsymbol{x}^{(1)}, \ldots, \boldsymbol{x}^{(T)}\right) &=P\left(\boldsymbol{x}^{(1)}\right) \times P\left(\boldsymbol{x}^{(2)} | \boldsymbol{x}^{(1)}\right) \times \cdots \times P\left(\boldsymbol{x}^{(T)} | \boldsymbol{x}^{(T-1)}, \ldots, \boldsymbol{x}^{(1)}\right) \\ &=\prod_{t=1}^{T} P\left(\boldsymbol{x}^{(t)} | \boldsymbol{x}^{(t-1)}, \ldots, \boldsymbol{x}^{(1)}\right) \end{aligned}</script><h2 id="N-gram-Language-Models"><a href="#N-gram-Language-Models" class="headerlink" title="N-gram Language Models"></a>N-gram Language Models</h2><p><strong>Definition:</strong> A n-gram is a chunk of n consecutive words.</p>
<p><strong>Idea:</strong> Collect statistics about how frequent different n-grams are, and use these to predict next word.</p>
<p><strong>Assumption:</strong> $x^{t=1}$ depends only on the preceding $n-1$ words.</p>
<script type="math/tex; mode=display">
P\left(\boldsymbol{x}^{(t+1)} | \boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(1)}\right)=P\left(\boldsymbol{x}^{(t+1)} | \boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(t-n+2)}\right) \\
=\frac{P\left(\boldsymbol{x}^{(t+1)}, \boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(t-n+2)}\right)}{P\left(\boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(t-n+2)}\right)}</script><p><strong>Counting:</strong> by counting in some large corpus of text, we get these n-gram and (n-1)-gram probabilities.</p>
<script type="math/tex; mode=display">
\approx \frac{\operatorname{count}\left(\boldsymbol{x}^{(t+1)}, \boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(t-n+2)}\right)}{\operatorname{count}\left(\boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(t-n+2)}\right)}</script><p><strong>Problems:</strong> </p>
<ol>
<li><p>Sparsity Problems with n-gram Language Models</p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.06.49 PM.png" alt="creen Shot 2019-08-02 at 5.06.49 P"></p>
</li>
<li><p>Storage Problems with n-gram Language Models</p>
<p>Need to store count for all n-grams you saw in the corpus and increasing n or increasing corpus increases model size!</p>
</li>
</ol>
<h2 id="Neural-Language-Model"><a href="#Neural-Language-Model" class="headerlink" title="Neural Language Model"></a>Neural Language Model</h2><h3 id="A-fixed-window-neural-Language-Model"><a href="#A-fixed-window-neural-Language-Model" class="headerlink" title="A fixed-window neural Language Model"></a>A fixed-window neural Language Model</h3><p>Say we have the sentence: </p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.11.21 PM.png" alt="creen Shot 2019-08-02 at 5.11.21 P">  </p>
<p>Then we use the neural network to build the model</p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.12.00 PM.png" alt="creen Shot 2019-08-02 at 5.12.00 P"></p>
<p><strong>Improvements</strong> over n-gram LM:</p>
<ol>
<li>No sparsity problem</li>
<li>Don’t need to store all observed n-grams</li>
</ol>
<p><strong>Remaining problems:</strong></p>
<ol>
<li>Fixed window is too small</li>
<li>Enlarging window enlarges $W$ while Window can never be large enough!</li>
<li>$ x^{(1)}$and $ x^{(2)}$ are multiplied by completely different weights in $W$. No symmetry in how the inputs are processed.</li>
</ol>
<p><strong>We need a neural architecture that can process any length input.</strong></p>
<h3 id="RNN"><a href="#RNN" class="headerlink" title="RNN"></a>RNN</h3><p><strong>Core idea:</strong> Apply the same weights $W$ repeatedly.</p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.19.53 PM.png" alt="creen Shot 2019-08-02 at 5.19.53 P"></p>
<p><strong>RNN Advantages:</strong></p>
<ol>
<li>Can process any length input</li>
<li>Computation for step t can (in theory) use information from many steps back</li>
<li>Model size doesn’t increase for longer input</li>
<li>Same weights applied on every timestep, so there is symmetry in how inputs are processed.</li>
</ol>
<p><strong>RNN Disadvantages:</strong></p>
<ol>
<li>Recurrent computation is slow</li>
<li>In practice, difficult to access information from many steps back</li>
</ol>
<h4 id="Training-a-RNN"><a href="#Training-a-RNN" class="headerlink" title="Training a RNN"></a>Training a RNN</h4><p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.23.37 PM.png" alt="creen Shot 2019-08-02 at 5.23.37 P"></p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.23.04 PM.png" alt="creen Shot 2019-08-02 at 5.23.04 P"></p>
<h2 id="Evaluating-Language-Models"><a href="#Evaluating-Language-Models" class="headerlink" title="Evaluating Language Models"></a>Evaluating Language Models</h2><p>In general, perplexity is a measurement of <strong>how well a probability model predicts a sample</strong>. </p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.37.29 PM.png" alt="creen Shot 2019-08-02 at 5.37.29 P"></p>
<p><img src="/2019/03/18/NLP-Attention/Screen Shot 2019-08-02 at 5.51.16 PM.png" alt="creen Shot 2019-08-02 at 5.51.16 P"></p>
<blockquote>
<p>Normalizing by the length is to avoid the pitfall that bigger corpus have smaller perplexity.</p>
</blockquote>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><a href="https://zhuanlan.zhihu.com/p/53682800" target="_blank" rel="noopener">nlp中的Attention注意力机制+Transformer详解</a> </li>
<li><a href="https://zhuanlan.zhihu.com/p/37601161" target="_blank" rel="noopener">great intriduction</a></li>
<li><a href="https://dzone.com/articles/self-attention-mechanisms-in-natural-language-proc" target="_blank" rel="noopener">good attention introduction</a> </li>
<li><a href="https://github.com/johnsmithm/multi-heads-attention-image-classification" target="_blank" rel="noopener">multi-heads-attention-image-classification</a> </li>
<li><a href="http://jalammar.github.io/illustrated-transformer/" target="_blank" rel="noopener">great explanation on self-attention</a> </li>
<li><a href="https://mlexplained.com/2017/12/29/attention-is-all-you-need-explained/" target="_blank" rel="noopener">self-attention in Pytorch code</a> <a href="https://nlp.seas.harvard.edu/2018/04/03/attention.html" target="_blank" rel="noopener">code2</a> </li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Deep-Learning/" rel="tag"># Deep Learning</a>
          
            <a href="/tags/NLP/" rel="tag"># NLP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/18/DP-Tensorflow/" rel="next" title="DP-Tensorflow">
                <i class="fa fa-chevron-left"></i> DP-Tensorflow
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/05/DP-FullyConvolutionalSegmentation/" rel="prev" title="DP-FullyConvolutionalSegmentation">
                DP-FullyConvolutionalSegmentation <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Qing Wong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">88</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">65</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Attention-in-Seq2seq"><span class="nav-number">1.</span> <span class="nav-text">Attention in Seq2seq</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Attention-in-General"><span class="nav-number">2.</span> <span class="nav-text">Attention in General</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Self-Attention"><span class="nav-number">3.</span> <span class="nav-text">Self-Attention</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bring-the-tensors-into-the-picture"><span class="nav-number">3.1.</span> <span class="nav-text">Bring the tensors into the picture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Matrix-calculation-of-Self-Attention"><span class="nav-number">3.2.</span> <span class="nav-text">Matrix calculation of Self-Attention</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multi-heads"><span class="nav-number">3.3.</span> <span class="nav-text">Multi heads</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sequence-order"><span class="nav-number">3.4.</span> <span class="nav-text">Sequence order</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-residuals"><span class="nav-number">3.5.</span> <span class="nav-text">The residuals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Decoder-side"><span class="nav-number">3.6.</span> <span class="nav-text">Decoder side</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Attention-in-GAN"><span class="nav-number">4.</span> <span class="nav-text">Attention in GAN</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-model"><span class="nav-number">4.1.</span> <span class="nav-text">The model</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Language-Model"><span class="nav-number">5.</span> <span class="nav-text">Language Model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#N-gram-Language-Models"><span class="nav-number">5.1.</span> <span class="nav-text">N-gram Language Models</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Neural-Language-Model"><span class="nav-number">5.2.</span> <span class="nav-text">Neural Language Model</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-fixed-window-neural-Language-Model"><span class="nav-number">5.2.1.</span> <span class="nav-text">A fixed-window neural Language Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RNN"><span class="nav-number">5.2.2.</span> <span class="nav-text">RNN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Training-a-RNN"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">Training a RNN</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Evaluating-Language-Models"><span class="nav-number">5.3.</span> <span class="nav-text">Evaluating Language Models</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">6.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qing Wong</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
